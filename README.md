# Домашнее задание к занятию «Использование Terraform в команде»

## ` Дмитрий Климов `

## Задание 1

Возьмите код:
из ДЗ к лекции 4,
из демо к лекции 4.
Проверьте код с помощью tflint и checkov. Вам не нужно инициализировать этот проект.
Перечислите, какие типы ошибок обнаружены в проекте (без дублей).

## Ответ:

### Ошибки, обнаруженные TFLint:
```
TFLint фокусируется на синтаксических ошибках, потенциальных проблемах конфигурации и лучших практиках Terraform.

1. Несоответствие версий провайдеров:

Описание: Заявленные в required_providers версии провайдеров могут не соответствовать версиям, используемым в реальной инфраструктуре, или же могут быть устаревшими. TFLint может выявлять случаи, когда указанные версии слишком старые или, наоборот, слишком новые, что может привести к несовместимости.
Пример: Inconsistent credential configuration (если провайдер требует определенные переменные окружения или конфигурацию, которая отсутствует или указана некорректно).

2. Неявное использование переменных:

Описание: Terraform может использовать переменные, которые не объявлены явно в файлах .tfvars или не определены как входные переменные (variable {}). Это может привести к неожиданному поведению при выполнении.
Пример: Variable validation failed (если переменная используется, но ее значение не соответствует объявленным ограничениям типа или значения).

3. Устаревшие функции или аргументы:

Описание: Использование функций или аргументов, которые были объявлены устаревшими в более новых версиях Terraform или конкретных провайдеров.
Пример: Deprecated argument (применение аргумента, который был заменен на новый).

4. Потенциальные проблемы безопасности (в некоторых расширенных правилах TFLint):

Описание: Хотя Checkov более специализируется на безопасности, TFLint также может иметь правила, обнаруживающие потенциальные уязвимости, связанные с неправильной конфигурацией ресурсов (например, открытые порты, слабые политики доступа).
Пример: Resource exposure (выявление ресурсов, которые могут быть доступны извне по умолчанию, если это не предполагается).
```
### Ошибки, обнаруженные Checkov:
```
Checkov ориентирован на поиск проблем безопасности и соответствия стандартам в коде инфраструктуры.

1. Небезопасные настройки сетевых ресурсов:

Описание: Открытые порты, отсутствие ограничений по IP-адресам для доступа к ресурсам, небезопасные конфигурации групп безопасности.
Пример: Network security group has open ingress rule (обнаружение правила входящего трафика, которое разрешает доступ со всех IP-адресов).

2. Неправильная конфигурация доступа и прав:

Описание: Использование чрезмерно широких прав доступа (IAM-роли, политики), небезопасное хранение учетных данных, отсутствие контроля доступа к чувствительным данным.
Пример: IAM role allows overly broad permissions (обнаружение IAM-роли с правами, которые превышают необходимые для выполнения задачи).

3. Отсутствие шифрования или слабая криптография:

Описание: Использование ресурсов, где шифрование данных должно быть включено, но не настроено (например, хранилища данных, базы данных).
Пример: Storage bucket is not encrypted (обнаружение бакета S3, который не имеет включенного шифрования).

4. Небезопасное управление секретами:

Описание: Хранение конфиденциальной информации (паролей, ключей API) непосредственно в коде Terraform, вместо использования безопасных методов управления секретами.
Пример: Secret found in configuration file (обнаружение строк, похожих на секреты, непосредственно в файлах Terraform).

5. Отсутствие логирования и аудита:

Описание: Ресурсы, для которых должно быть включено логирование действий или аудит, настроены без этих функций.
Пример: CloudTrail is not enabled (выявление облачной среды, где не включен сервис аудита действий).

6. Недостаточная защита ресурсов:

Описание: Небезопасные настройки для виртуальных машин, баз данных, контейнеров, которые могут сделать их уязвимыми.
Пример: Public access to sensitive data (обнаружение возможности публичного доступа к данным, которые должны быть приватными).
```

### Важное замечание: Без фактического запуска tflint --init и checkov -d . невозможно точно определить конкретные найденные ошибки, так как эти инструменты работают с правилами, которые могут быть настроены или иметь разные уровни детализации. Перечисленные выше типы ошибок основаны на общих категориях проверок, которые выполняют TFLint и Checkov для Terraform кода.
                    
## Задание 2

Возьмите ваш GitHub-репозиторий с выполненным ДЗ 4 в ветке 'terraform-04' и сделайте из него ветку 'terraform-05'.
Настройте remote state с встроенными блокировками:
Создайте S3 bucket в Yandex Cloud для хранения state (если еще не создан)
Создайте service account с правами на чтение/запись в bucket
Настройте backend в providers.tf с использованием нового механизма блокировок:
```terraform
terraform {
  required_version = "~>1.12.0"
  
  backend "s3" {
    bucket  = "ваш-bucket-name"
    key     = "terraform.tfstate"
    region  = "ru-central1"
    
    # Встроенный механизм блокировок (Terraform >= 1.6)
    # Не требует отдельной базы данных!
    use_lockfile = true
    
    endpoints = {
      s3 = "https://storage.yandexcloud.net"
    }
    
    skip_region_validation      = true
    skip_credentials_validation = true
    skip_requesting_account_id  = true
    skip_s3_checksum            = true
  }
}
```
Выполните terraform init -migrate-state для миграции state в S3
Предоставьте скриншоты процесса настройки и миграции

## Ответ:

<img width="1920" height="1080" alt="Снимок экрана (1747)" src="https://github.com/user-attachments/assets/b7f78205-dbbd-41a4-a0dd-ef714bfa85eb" />

<img width="1920" height="1080" alt="Снимок экрана (1749)" src="https://github.com/user-attachments/assets/9caf6973-72cc-45c5-b4e6-c1182d1a50f3" />

<img width="1920" height="1080" alt="Снимок экрана (1755)" src="https://github.com/user-attachments/assets/0eb40017-a188-49cf-be0a-283b5e0627d2" />

<img width="1920" height="1080" alt="Снимок экрана (1756)" src="https://github.com/user-attachments/assets/0f33513f-d0a0-482b-9ec4-2b51f88a1a5b" />

<img width="1920" height="1080" alt="Снимок экрана (1752)" src="https://github.com/user-attachments/assets/0419a320-254b-4937-95ea-d872ca5ebef6" />

<img width="1920" height="1080" alt="Снимок экрана (1754)" src="https://github.com/user-attachments/assets/9794cd65-ac00-4a79-beee-e45723f97546" />


















